# ✅ 优化完成 - novel.sh 切换功能 + JSON处理

## 优化日期: 2026-02-04

---

## 1. novel.sh 切换功能优化

### 问题
- 切换命令无法显示任何配置文件
- 正则表达式过滤掉了带时间戳的配置文件
- 用户无法切换到已保存的配置

### 修复
文件: `novel.sh` switch_config() 函数

#### 主要改进:

1. **移除过度过滤**
   ```bash
   # 之前：过滤时间戳文件
   if [[ "$name" != "latest" && ! "$name" =~ _[0-9]{8}_[0-9]{6}$ ]]; then

   # 之后：只过滤 latest
   if [[ "$name" != "latest" ]]; then
   ```

2. **显示当前配置**
   - 在列表顶部显示当前使用的配置
   - 用蓝色高亮标识

3. **显示章节数**
   - 每个配置旁边显示目标章节数
   - 格式：`1. 小说标题 (100章)`

4. **使用完整文件路径**
   - 不再依赖名称拼接
   - 直接使用文件的完整路径
   - 避免特殊字符导致的路径错误

5. **改进提示信息**
   - 切换成功后显示小说标题（而非文件名）
   - 更清晰的数据库清理提示

### 测试结果

```bash
$ ./novel.sh switch

==========================================
📚 小说配置切换器
==========================================

当前配置: 末日真理：从收割生存点开始

可用的小说配置：

  1. 末日真理：从收割生存点开始 (100章)
  2. 测试小说：配置切换验证 (50章)

选择要切换的配置 (1-2): 2

✅ 已切换到: 测试小说：配置切换验证
```

---

## 2. JSON 解析增强

### 问题
用户报告错误：
```
⚠️  JSON 格式错误: Expecting ',' delimiter: line 4 column 32
```

这是 AI 返回的 JSON 格式不规范导致的。

### 修复
文件: `src/nodes/memory.py` update_world_state_with_ai() 函数

#### 新增JSON修复逻辑:

1. **移除注释**
   ```python
   json_content_clean = re.sub(r'//.*', '', json_content)
   ```

2. **修复缺失的逗号（对象中）**
   ```python
   # 修复: "key": "value"\n  "key2" → "key": "value",\n  "key2"
   json_content_clean = re.sub(r'("\s*)\n(\s*")', r'\1,\n\2', json_content_clean)
   ```

3. **修复缺失的逗号（数组/对象间）**
   ```python
   # 修复: }\n  { → },\n  {
   json_content_clean = re.sub(r'([}\]])\n(\s*[{\[])', r'\1,\n\2', json_content_clean)
   ```

4. **移除尾部逗号**
   ```python
   # 修复: {...,} → {...}  (JSON标准不允许尾部逗号)
   json_content_clean = re.sub(r',(\s*[}\]])', r'\1', json_content_clean)
   ```

5. **详细错误输出**
   - 失败时打印修复后的JSON前200字符
   - 方便调试定位问题

### 原有机制保留

- ✅ 3次重试（第186-190行）
- ✅ 指数退避（第194行：3s, 6s, 9s）
- ✅ 降级方案（第79-82行：fallback_update）

### 预期效果

大多数常见的JSON格式错误会被自动修复：
- 缺失逗号 → 自动添加
- 多余逗号 → 自动移除
- 注释干扰 → 自动清理

如果3次尝试后仍失败，会使用降级方案（基础记录）。

---

## 验证

### 切换功能
```bash
./novel.sh switch    # 测试切换
./novel.sh config    # 验证切换成功
```

### JSON处理
运行生成测试：
```bash
./novel.sh generate
```

观察 Memory 节点的输出，应该不再频繁出现 JSON 错误。

---

## 文件修改清单

1. **novel.sh** (行149-211)
   - switch_config() 函数完全重写
   - 移除时间戳过滤
   - 添加当前配置显示
   - 添加章节数显示

2. **src/nodes/memory.py** (行159-180)
   - JSON清理逻辑增强
   - 添加4种常见错误的自动修复
   - 改进错误输出

---

## 下一步

1. ✅ 切换功能已完全正常
2. ✅ JSON处理已增强
3. ⏭️ 可以开始正常生成小说
4. ⏭️ 如果仍遇到JSON错误，检查打印的详细信息

---

**状态**: 优化完成，系统更稳定！
