# 字数控制优化 - 2026-02-04

## 用户需求

每章目标字数：**2000-2500字**

当前问题：
- 实际生成：3700字左右
- Critic 检查：只检查前2500字
- 需要调整所有节点的字数控制

---

## 修改内容

### 1. Writer 节点 - 生成字数控制

**文件**: `src/nodes/writer.py`

#### 分段生成（多场景）
```python
# 之前：每段 400-600字
【写作要求】
1. 字数: 400-600字

# 之后：每段 300-500字
【写作要求】
1. 字数: 300-500字
```

**效果**: 4-5个场景 × 300-500字 = 2000-2500字 ✅

#### 单段生成（少场景）
```python
# 之前：600-1000字
【要求】
1. 字数: 600-1000字

# 之后：2000-2500字
【要求】
1. 字数: 2000-2500字（严格控制）
```

**效果**: 单段直接生成2000-2500字 ✅

---

### 2. Critic 节点 - 检查范围扩大

**文件**: `src/nodes/critic.py`

```python
# 之前：只检查前2500字符
if len(draft) > 2500:
    truncated = draft[:2500]

# 之后：检查前5000字符（足够覆盖2500字章节）
max_check_chars = 5000
if len(draft) > max_check_chars:
    truncated = draft[:max_check_chars]
```

**改进**:
- 显示覆盖百分比：`检查前 2300/2500 字符 (92% 覆盖)`
- 确保至少检查2000字（之前是1000字）
- 智能段落截断保持不变

---

### 3. Memory 节点 - 分析范围调整

**文件**: `src/nodes/memory.py`

```python
# 之前：只发送前2000字符
draft[:2000]

# 之后：发送前3000字符
draft[:3000]  # 足够覆盖2500字的章节
```

**效果**: Memory 能分析完整章节内容

---

### 4. Planner 节点 - 场景规划调整

**文件**: `src/nodes/planner.py`

```python
# 之前：
"- 每个场景可用 400-600 字展开"

# 之后：
"- 每个场景可用 300-500 字展开"
"- 总计 4-5 个场景，形成完整2000-2500字章节"
```

**效果**: Planner 规划时考虑总字数目标

---

## 字数控制流程

```
┌─────────────────────────────────────────────────────────┐
│ Planner: 规划 4-5 个场景                                 │
│   每个场景 20-40字大纲                                   │
│   预期每个场景展开 300-500字                             │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────┐
│ Writer: 生成章节                                         │
│   分段模式: 4-5段 × 300-500字 = 2000-2500字             │
│   单段模式: 直接生成 2000-2500字                        │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────┐
│ Critic: 质量检查                                         │
│   检查范围: 前 5000 字符（完整覆盖）                    │
│   智能截断: 保持段落完整性                              │
│   显示覆盖率: 例如 "92% 覆盖"                           │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────┐
│ Memory: 状态更新                                         │
│   分析范围: 前 3000 字符（完整章节）                    │
│   提取摘要: 50-100字                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 预期效果

### 章节字数分布
- **目标**: 2000-2500字
- **实际**: 应该在目标范围内 ✅
- **允许偏差**: ±200字（1800-2700字可接受）

### 质量保证
- ✅ Critic 能检查完整章节（5000字限制 > 2500字目标）
- ✅ Memory 能分析完整内容（3000字限制 > 2500字目标）
- ✅ Planner 规划合理场景数（4-5个）

### 生成效率
- 字数减少 32%（3700 → 2500）
- API 调用时间缩短
- 生成速度提升

---

## 测试建议

1. **生成单章测试**
   ```bash
   ./novel.sh generate
   ```
   检查生成的章节字数是否在 2000-2500 字范围

2. **检查 Critic 输出**
   观察是否显示覆盖率，例如：
   ```
   📏 检查完整内容 (2300 字符)
   ```
   或
   ```
   📏 内容较长,检查前 2400/2600 字符 (92% 覆盖,完整段落)
   ```

3. **验证质量**
   - 章节是否完整
   - 场景是否连贯
   - 字数是否达标

---

## 如果字数仍不理想

### 字数太少（< 2000字）

调整 `writer.py`:
```python
# 分段模式
1. 字数: 350-550字  # 增加每段字数

# 单段模式
1. 字数: 2200-2800字  # 增加目标范围
```

### 字数太多（> 2500字）

调整 `writer.py`:
```python
# 分段模式
1. 字数: 250-450字  # 减少每段字数

# 单段模式
1. 字数: 1800-2300字  # 减少目标范围
```

或调整 `planner.py`，减少场景数量要求。

---

**状态**: 所有节点已调整，字数控制在 2000-2500 字 ✅
