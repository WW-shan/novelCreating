# ⚠️ 代理服务器超时问题说明

## 问题描述

你的 API 代理服务器 (`claud.bfund.pro`) 存在严重的超时问题：

```
Error 524: A timeout occurred
Cloudflare Ray ID: 9c8ac17b6938234f
```

### 根本原因

1. **代理服务器超时限制太短**: Cloudflare 默认超时约 100 秒
2. **AI 生成需要时间**: 即使是 Sonnet 4.5 生成 800+ 字也需要 60-120 秒
3. **代理服务器不稳定**: 频繁触发 524 错误

## 已实施的临时方案

### 1. 手动重试机制

已在 `writer.py` 中实现 5 次重试：

```python
max_attempts = 5  # 尝试 5 次
wait_time = (attempt + 1) * 5  # 5s, 10s, 15s, 20s
```

### 2. 减少生成字数

```python
- Write at least 800 words  # 从 2000 降低到 800
```

### 3. 缩短超时时间

```python
timeout=120.0  # 从 180s 降低到 120s
```

### 4. 优雅降级

如果 5 次尝试都失败，会生成一个占位章节并继续流程，而不是完全崩溃。

---

## 长期解决方案

### 🔑 方案 A: 使用官方 Anthropic API（推荐）

**优点**:
- ✅ 完全稳定，无超时问题
- ✅ 速度更快
- ✅ 更高的可靠性

**缺点**:
- ❌ 需要官方 API Key
- ❌ 成本较高（但代理也不便宜）

**配置方法**:

```bash
# 编辑 .env
vim .env

# 修改为:
ANTHROPIC_API_KEY=sk-ant-api03-你的官方Key
# 删除或注释掉这行:
# ANTHROPIC_BASE_URL=https://claud.bfund.pro/api

# 测试
./test_api.sh
```

**获取官方 Key**:
1. 访问: https://console.anthropic.com/
2. 注册账号
3. 创建 API Key
4. 充值余额（按使用量付费）

### 🔄 方案 B: 更换代理服务器

寻找更稳定的代理服务商：

```bash
# 编辑 .env
ANTHROPIC_BASE_URL=https://另一个代理服务器/api
```

**评估标准**:
- Cloudflare 超时设置 \u003e 300s
- 支持流式响应
- 稳定的 uptime

### 📝 方案 C: 进一步缩短生成内容

**临时措施**:

编辑 `src/nodes/writer.py`:

```python
# 改为只生成 400-500 字
- Write at least 400 words.
```

**缺点**:
- 章节太短，质量下降
- 不是长期方案

### 🔀 方案 D: 分段生成（复杂但可靠）

将长章节拆分成多个小段生成：

```python
def writer_node_split(state):
    # 1. 将 beats 拆分成 3-4 段
    # 2. 每段生成 200-300 字
    # 3. 合并成完整章节
    pass
```

我可以实现这个，但需要较大改动。

---

## 当前状态

### Writer 节点优化

✅ 已实现 5 次自动重试
✅ 已降低字数要求 (2000 → 800)
✅ 已缩短超时 (180s → 120s)
✅ 已添加详细日志
✅ 已实现优雅降级

### 运行效果

```bash
./run_novel.sh

# 预期输出:
--- WRITER NODE ---
  尝试生成章节... (第 1/5 次)
  ❌ 第 1 次尝试失败
     原因: 代理服务器超时 (524 错误)
  ⏳ 等待 5 秒后重试...
  尝试生成章节... (第 2/5 次)
  ✅ 生成成功！字数: 1234 字符
```

或者（如果持续失败）:

```bash
  ⚠️  所有 5 次尝试均失败
  💡 建议: 1) 等待几分钟后重试  2) 检查代理服务器状态

[生成占位章节，继续流程]
```

---

## 建议行动步骤

### 立即可做（临时缓解）

1. **等待一段时间**
   ```bash
   # 等待 10-15 分钟
   sleep 900

   # 重新运行
   ./run_novel.sh
   ```

2. **多次重试**
   ```bash
   # 如果失败，删除状态重试
   rm novel_state.db*
   ./run_novel.sh
   ```

3. **降低章节数测试**
   ```bash
   # 编辑配置
   vim bible/novel_config_latest.yaml

   # 修改为:
   target_chapters: 1  # 先测试生成 1 章
   ```

### 中期方案（1-2天内）

1. **联系代理服务商**
   - 询问是否可以增加超时限制
   - 或请求退款/更换服务

2. **寻找替代代理**
   - 搜索: "Anthropic API 代理 稳定"
   - 评估其他服务商

### 长期方案（推荐）

1. **申请官方 API Key**
   - 访问 https://console.anthropic.com/
   - 注册并充值
   - 使用官方 API（最稳定）

2. **自建代理**
   - 如果你有服务器
   - 可以自建中转代理
   - 完全控制超时设置

---

## 成本对比

### 当前代理 (claud.bfund.pro)

```
费用: 未知（你的套餐）
稳定性: ❌ 差（频繁 524 超时）
可用性: ~30-50%（估算）
```

### 官方 API

```
费用: 按使用量
- Sonnet 4.5: $0.003/1K input, $0.015/1K output
- 单章成本: ~$0.06
- 100章成本: ~$6

稳定性: ✅ 优秀
可用性: 99.9%+
```

### 结论

即使官方 API 收费，但考虑到时间成本和稳定性，**强烈推荐切换到官方 API**。

---

## 技术细节

### 为什么会超时？

1. **Cloudflare 限制**: 代理使用 Cloudflare，默认超时 100s
2. **AI 生成时间**: 生成 800+ 字需要 60-120s
3. **网络延迟**: 代理转发增加延迟
4. **负载**: 代理服务器可能过载

### 为什么重试也失败？

524 错误通常意味着：
- 代理服务器本身性能不足
- Cloudflare 配置不当
- 上游 API 响应慢

重试只能缓解偶发问题，无法解决根本原因。

### 为什么不用 Opus？

Opus 4.5 更慢，更容易超时。Sonnet 4.5 已经是最快的选择。

---

## 监控和日志

### 查看实时日志

```bash
# 运行生成时，查看详细输出
./run_novel.sh 2>&1 | tee generation.log

# 统计失败次数
grep "❌ 第.*次尝试失败" generation.log | wc -l

# 查看成功率
grep "✅ 生成成功" generation.log | wc -l
```

### 记录错误模式

```bash
# 提取所有错误
grep "原因:" generation.log

# 常见的:
# - 代理服务器超时 (524 错误)  ← 最常见
# - 连接超时
# - 读取超时
```

---

## FAQ

### Q: 能否进一步增加重试次数？

A: 可以，编辑 `src/nodes/writer.py`:

```python
max_attempts = 10  # 改为 10 次
```

但这只是拖延时间，不能根本解决问题。

### Q: 能否降低到 500 字？

A: 可以，但质量会下降。建议最低 600-800 字。

### Q: 重试间隔能否调整？

A: 可以，编辑 `src/nodes/writer.py`:

```python
wait_time = (attempt + 1) * 10  # 改为 10s, 20s, 30s...
```

### Q: 如果占位章节太多怎么办？

A: 稍后可以重新生成那几章：

```python
# 创建一个脚本，只生成特定章节
# 需要自定义开发
```

### Q: 官方 API 有免费额度吗？

A: 新用户通常有 $5-10 的免费额度，足够测试几十章。

---

## 联系支持

如果需要进一步帮助：

1. **代理服务商**: 联系 bfund.pro 客服
2. **Anthropic 官方**: https://www.anthropic.com/contact
3. **社区**: Reddit r/ClaudeAI

---

**文档版本**: 1.0
**最后更新**: 2026-02-04
**建议**: 尽快切换到官方 API 🔑
