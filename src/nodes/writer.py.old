from langchain_core.messages import HumanMessage
from langchain_anthropic import ChatAnthropic
from src.state import NovelState
import os
import json
import time
import re

def writer_node(state: NovelState) -> NovelState:
    """
    The Writer Node - High quality chapter generation.
    Uses segmented generation with quality control.
    """
    print("--- WRITER NODE ---")

    current_beats = state.get("current_beats", "")
    world_bible = state.get("world_bible", {})
    synopsis = state.get("synopsis", "")
    characters = world_bible.get("characters", {})
    chapter_index = state.get('current_chapter_index', 1)
    config = state.get('config', {})

    # ä»é…ç½®è¯»å–å†™ä½œé£æ ¼
    style = config.get('style', {})
    tone = style.get('tone', 'neutral')
    focus_elements = style.get('focus_elements', [])

    print(f"  ğŸ“ ç« èŠ‚ {chapter_index} - åˆ†æ®µç”Ÿæˆç­–ç•¥ï¼ˆé«˜è´¨é‡æ¨¡å¼ï¼‰")
    print(f"     é£æ ¼: {tone}, é‡ç‚¹: {focus_elements}")

    # æ‹†åˆ† beats
    beat_lines = [line.strip() for line in current_beats.split('\n') if line.strip()]

    if len(beat_lines) <= 2:
        print(f"  ğŸ“Œ åœºæ™¯è¾ƒå°‘ ({len(beat_lines)} ä¸ª)ï¼Œä½¿ç”¨å•æ®µç”Ÿæˆ")
        return generate_single_segment_quality(current_beats, characters, chapter_index, state, tone, focus_elements)

    # åˆ†æ®µç”Ÿæˆ
    print(f"  ğŸ“Œ åœºæ™¯è¾ƒå¤š ({len(beat_lines)} ä¸ª)ï¼Œåˆ†æ®µç”Ÿæˆ")

    segments = []
    for i, beat in enumerate(beat_lines, 1):
        print(f"\n  ğŸ”¸ ç”Ÿæˆç¬¬ {i}/{len(beat_lines)} æ®µ...")

        segment = generate_segment_quality(
            beat=beat,
            segment_num=i,
            total_segments=len(beat_lines),
            characters=characters,
            previous_content="\n\n".join(segments),
            chapter_index=chapter_index,
            tone=tone,
            focus_elements=focus_elements
        )

        if segment:
            segments.append(segment)
            word_count = len(segment)
            print(f"     âœ… ç¬¬ {i} æ®µå®Œæˆ ({word_count} å­—ç¬¦)")
        else:
            print(f"     âš ï¸  ç¬¬ {i} æ®µç”Ÿæˆå¤±è´¥")
            segments.append(f"\n\n[åœºæ™¯ {i}: {beat}]\nï¼ˆæœ¬æ®µæš‚æœªç”Ÿæˆï¼‰\n")

    # åˆå¹¶å¹¶æ¶¦è‰²
    full_draft = f"# ç¬¬ {chapter_index} ç« \n\n" + "\n\n".join(segments)

    # è´¨é‡æ£€æŸ¥
    quality_issues = check_quality(full_draft, characters)
    if quality_issues:
        print(f"\n  âš ï¸  è´¨é‡æ£€æŸ¥å‘ç° {len(quality_issues)} ä¸ªé—®é¢˜:")
        for issue in quality_issues[:3]:
            print(f"     - {issue}")

    total_chars = len(full_draft)
    print(f"\n  âœ… ç« èŠ‚å®Œæˆï¼æ€»å­—æ•°: {total_chars} å­—ç¬¦")

    return {"draft": full_draft, "iteration": state.get("iteration", 0) + 1}


def generate_segment_quality(beat, segment_num, total_segments, characters, previous_content, chapter_index, tone, focus_elements):
    """é«˜è´¨é‡æ®µè½ç”Ÿæˆ"""

    # æ„å»ºä¸Šä¸‹æ–‡
    context_snippet = ""
    if previous_content:
        context_snippet = previous_content[-600:] if len(previous_content) > 600 else previous_content

    # æ„å»ºé£æ ¼æŒ‡å¯¼
    tone_guides = {
        'serious': 'ç”¨ä¸¥è‚ƒã€æ­£å¼çš„å™äº‹å£å»ï¼Œæ³¨é‡äººç‰©å†…å¿ƒæ´»åŠ¨çš„æ·±åº¦åˆ»ç”»ã€‚',
        'humorous': 'ç”¨è½»æ¾ã€å¹½é»˜çš„è¯­è¨€ï¼Œå¯¹è¯è¦æœºæ™ºé£è¶£ã€‚',
        'dark': 'ç”¨é˜´æš—ã€å‹æŠ‘çš„æ°›å›´æå†™ï¼Œçªå‡ºç¯å¢ƒçš„æ²‰é‡æ„Ÿã€‚',
        'passionate': 'ç”¨æ¿€æ˜‚ã€çƒ­è¡€çš„è¯­è¨€ï¼ŒåŠ¨ä½œåœºé¢è¦ç”ŸåŠ¨æœ‰åŠ›ã€‚',
        'romantic': 'ç”¨æ¸©æŸ”ã€ç»†è…»çš„ç¬”è§¦ï¼Œæ³¨é‡æƒ…æ„Ÿçš„å¾®å¦™å˜åŒ–ã€‚'
    }
    tone_instruction = tone_guides.get(tone, '')

    # æ„å»ºé‡ç‚¹æŒ‡å¯¼
    focus_instructions = []
    if 'action' in focus_elements:
        focus_instructions.append('- å¼ºè°ƒåŠ¨ä½œåœºé¢ï¼Œä½¿ç”¨ç”ŸåŠ¨çš„åŠ¨è¯')
    if 'dialogue' in focus_elements:
        focus_instructions.append('- é€šè¿‡å¯¹è¯å±•ç°äººç‰©æ€§æ ¼ï¼Œå¯¹è¯è¦ç¬¦åˆäººç‰©èº«ä»½')
    if 'psychology' in focus_elements:
        focus_instructions.append('- æ·±å…¥æå†™äººç‰©å†…å¿ƒæ´»åŠ¨å’Œå¿ƒç†å˜åŒ–')
    if 'environment' in focus_elements:
        focus_instructions.append('- è¯¦ç»†æç»˜ç¯å¢ƒæ°›å›´ï¼Œä½¿ç”¨æ„Ÿå®˜ç»†èŠ‚')
    if 'suspense' in focus_elements:
        focus_instructions.append('- è®¾ç½®æ‚¬å¿µï¼Œæ§åˆ¶ä¿¡æ¯é€éœ²èŠ‚å¥')

    focus_text = '\n'.join(focus_instructions) if focus_instructions else ''

    prompt = f"""ä½ æ˜¯ä¸“ä¸šå°è¯´ä½œå®¶ï¼Œæ­£åœ¨åˆ›ä½œä¸€éƒ¨é«˜è´¨é‡å°è¯´ã€‚

ã€è§’è‰²ä¿¡æ¯ã€‘
{json.dumps(characters, indent=2, ensure_ascii=False)[:400]}

{'ã€å‰æ–‡å†…å®¹ã€‘ï¼ˆç”¨äºä¿æŒè¿è´¯ï¼‰\n' + context_snippet if context_snippet else 'ã€è¿™æ˜¯ç« èŠ‚å¼€å¤´ã€‘'}

ã€å½“å‰åœºæ™¯ã€‘ï¼ˆç¬¬ {segment_num}/{total_segments} æ®µï¼‰
{beat}

ã€å†™ä½œé£æ ¼ã€‘
{tone_instruction}

ã€å†™ä½œé‡ç‚¹ã€‘
{focus_text}

ã€å†™ä½œè¦æ±‚ã€‘
1. å­—æ•°: 400-600 å­—ï¼ˆçº¦ 800-1200 å­—ç¬¦ï¼‰
2. æ‰‹æ³•: "å±•ç¤ºè€Œéå‘ŠçŸ¥"ï¼ˆShow, don't tellï¼‰
3. ç»†èŠ‚: åŒ…å«è§†è§‰ã€å¬è§‰ã€è§¦è§‰ã€å—…è§‰ç­‰æ„Ÿå®˜ç»†èŠ‚
4. äººç‰©: å¯¹è¯å’Œè¡Œä¸ºè¦ç¬¦åˆè§’è‰²æ€§æ ¼è®¾å®š
5. èŠ‚å¥: é•¿çŸ­å¥ç»“åˆï¼Œé¿å…å•è°ƒ
6. è¯­è¨€: ç®€ä½“ä¸­æ–‡ï¼Œé¿å…é™ˆè¯æ»¥è°ƒ
7. è¿è´¯: {('å¦‚æœä¸æ˜¯å¼€å¤´ï¼Œè¦è‡ªç„¶è¡”æ¥å‰æ–‡' if segment_num > 1 else 'è¿™æ˜¯å¼€å¤´ï¼Œè¦å¼•äººå…¥èƒœ')}

ã€ç¦æ­¢ã€‘
- ä¸è¦ä½¿ç”¨"çªç„¶"ã€"åŸæ¥"ã€"ç«Ÿç„¶"ç­‰è¿‡åº¦è¯æ±‡
- ä¸è¦è¿‡åº¦ä½¿ç”¨"åªè§"ã€"åªå¬"ç­‰æ—ç™½å¼è¯­è¨€
- ä¸è¦ç”Ÿç¡¬åœ°è¯´æ˜äººç‰©æ€§æ ¼ï¼Œè¦é€šè¿‡è¡ŒåŠ¨å±•ç°
- ä¸è¦è„±ç¦»åœºæ™¯å¤§çº²ï¼Œæ·»åŠ æ— å…³å†…å®¹

è¯·ç›´æ¥è¾“å‡ºè¿™ä¸€æ®µçš„æ­£æ–‡å†…å®¹ï¼Œä¸è¦ä»»ä½•æ ‡é¢˜æˆ–è¯´æ˜ã€‚"""

    max_attempts = 3
    for attempt in range(max_attempts):
        try:
            llm = ChatAnthropic(
                model="claude-sonnet-4-5-20250929",
                temperature=0.85,  # ç¨é«˜çš„åˆ›é€ æ€§
                anthropic_api_key=os.getenv("ANTHROPIC_API_KEY"),
                anthropic_api_url=os.getenv("ANTHROPIC_BASE_URL"),
                timeout=75.0,  # ç¨é•¿çš„è¶…æ—¶ï¼Œä¿è¯è´¨é‡
                max_retries=0
            )

            response = llm.invoke([HumanMessage(content=prompt)])
            segment = response.content.strip()

            # ç®€å•è´¨é‡æ£€æŸ¥
            if len(segment) < 200:
                print(f"       âš ï¸  å†…å®¹è¿‡çŸ­ï¼Œé‡è¯•")
                if attempt < max_attempts - 1:
                    continue

            return segment

        except Exception as e:
            if attempt < max_attempts - 1:
                wait = (attempt + 1) * 4
                print(f"       â³ é‡è¯• ({attempt + 2}/{max_attempts})ï¼Œç­‰å¾… {wait}s...")
                time.sleep(wait)

    return None


def generate_single_segment_quality(beats, characters, chapter_index, state, tone, focus_elements):
    """å•æ®µé«˜è´¨é‡ç”Ÿæˆ"""

    tone_guides = {
        'serious': 'ç”¨ä¸¥è‚ƒã€æ­£å¼çš„å™äº‹å£å»ã€‚',
        'humorous': 'ç”¨è½»æ¾ã€å¹½é»˜çš„è¯­è¨€ã€‚',
        'dark': 'ç”¨é˜´æš—ã€å‹æŠ‘çš„æ°›å›´ã€‚',
        'passionate': 'ç”¨æ¿€æ˜‚ã€çƒ­è¡€çš„è¯­è¨€ã€‚',
        'romantic': 'ç”¨æ¸©æŸ”ã€ç»†è…»çš„ç¬”è§¦ã€‚'
    }
    tone_instruction = tone_guides.get(tone, '')

    focus_instructions = []
    if 'action' in focus_elements:
        focus_instructions.append('- å¼ºè°ƒåŠ¨ä½œåœºé¢')
    if 'dialogue' in focus_elements:
        focus_instructions.append('- é‡è§†å¯¹è¯åˆ»ç”»')
    if 'psychology' in focus_elements:
        focus_instructions.append('- æ·±å…¥å¿ƒç†æå†™')
    if 'environment' in focus_elements:
        focus_instructions.append('- è¯¦ç»†ç¯å¢ƒæç»˜')
    if 'suspense' in focus_elements:
        focus_instructions.append('- è¥é€ æ‚¬å¿µæ°›å›´')

    focus_text = '\n'.join(focus_instructions) if focus_instructions else ''

    prompt = f"""ä½ æ˜¯ä¸“ä¸šå°è¯´ä½œå®¶ï¼Œæ­£åœ¨åˆ›ä½œé«˜è´¨é‡å°è¯´ç« èŠ‚ã€‚

ã€è§’è‰²ä¿¡æ¯ã€‘
{json.dumps(characters, indent=2, ensure_ascii=False)[:500]}

ã€ç« èŠ‚å¤§çº²ã€‘
{beats}

ã€å†™ä½œé£æ ¼ã€‘
{tone_instruction}

ã€å†™ä½œé‡ç‚¹ã€‘
{focus_text}

ã€å†™ä½œè¦æ±‚ã€‘
1. å­—æ•°: 600-1000 å­—ï¼ˆçº¦ 1200-2000 å­—ç¬¦ï¼‰
2. æ‰‹æ³•: "å±•ç¤ºè€Œéå‘ŠçŸ¥"
3. ç»†èŠ‚: ä¸°å¯Œçš„æ„Ÿå®˜æå†™
4. äººç‰©: å¯¹è¯å’Œè¡Œä¸ºç¬¦åˆæ€§æ ¼
5. èŠ‚å¥: é•¿çŸ­å¥ç»“åˆ
6. è¯­è¨€: ç®€ä½“ä¸­æ–‡ï¼Œé¿å…é™ˆè¯æ»¥è°ƒ

ã€ç¦æ­¢ã€‘
- è¿‡åº¦ä½¿ç”¨"çªç„¶"ã€"åŸæ¥"ç­‰è¯æ±‡
- ç”Ÿç¡¬çš„æ€§æ ¼è¯´æ˜
- è„±ç¦»å¤§çº²çš„å†…å®¹

è¯·ç›´æ¥è¾“å‡ºç« èŠ‚æ­£æ–‡ï¼Œä¸è¦æ ‡é¢˜ã€‚"""

    max_attempts = 3
    for attempt in range(max_attempts):
        try:
            print(f"     å°è¯• {attempt + 1}/{max_attempts}...")

            llm = ChatAnthropic(
                model="claude-sonnet-4-5-20250929",
                temperature=0.85,
                anthropic_api_key=os.getenv("ANTHROPIC_API_KEY"),
                anthropic_api_url=os.getenv("ANTHROPIC_BASE_URL"),
                timeout=75.0,
                max_retries=0
            )

            response = llm.invoke([HumanMessage(content=prompt)])
            draft = f"# ç¬¬ {chapter_index} ç« \n\n" + response.content.strip()

            if len(response.content) < 500:
                print(f"     âš ï¸  å†…å®¹è¿‡çŸ­ï¼Œé‡è¯•")
                if attempt < max_attempts - 1:
                    continue

            print(f"     âœ… ç”ŸæˆæˆåŠŸ ({len(draft)} å­—ç¬¦)")
            return {"draft": draft, "iteration": state.get("iteration", 0) + 1}

        except Exception as e:
            if attempt < max_attempts - 1:
                wait = (attempt + 1) * 5
                print(f"     â³ é‡è¯•ï¼Œç­‰å¾… {wait}s...")
                time.sleep(wait)

    # å¤±è´¥
    fallback = f"""# ç¬¬ {chapter_index} ç« 

{beats}

ï¼ˆæœ¬ç« å› è¶…æ—¶æœªèƒ½ç”Ÿæˆè¯¦ç»†å†…å®¹ï¼‰"""

    return {"draft": fallback, "iteration": state.get("iteration", 0) + 1}


def check_quality(draft, characters):
    """ç®€å•çš„è´¨é‡æ£€æŸ¥"""
    issues = []

    # æ£€æŸ¥é•¿åº¦
    if len(draft) < 500:
        issues.append("ç« èŠ‚è¿‡çŸ­")

    # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡åº¦ä½¿ç”¨çš„è¯æ±‡
    overused_words = ['çªç„¶', 'åŸæ¥', 'ç«Ÿç„¶', 'åªè§', 'åªå¬']
    for word in overused_words:
        count = draft.count(word)
        if count > 3:
            issues.append(f"'{word}' ä½¿ç”¨è¿‡å¤š ({count} æ¬¡)")

    # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹è¯
    if 'ã€Œ' not in draft and '"' not in draft and '"' not in draft:
        issues.append("ç¼ºå°‘å¯¹è¯")

    return issues
